// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/NearMe/item-list.html":'\x3cdiv class\x3d"esriCTItemlList"\x3e\r\n    \x3cdiv class\x3d"esriCTBackButton"\x3e\r\n        \x3cdiv class\x3d"esriCTItemLeftArrow"\x3e\r\n        \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"esriCTItemRightArrow"\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"esriCTItemCount esriCTLoadingIcon"\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"esriCTItemName"\x3e\r\n    \x3c/div\x3e\r\n\x3c/div\x3e\r\n',"url:widgets/NearMe/swiperLayout.html":'\x3cdiv class\x3d"swiper-container"\x3e\r\n    \x3cdiv class\x3d"swiper-wrapper"\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"swiper-button-prev"\x3e\x3c/div\x3e\r\n    \x3cdiv class\x3d"swiper-button-next"\x3e\x3c/div\x3e\r\n    \x3cdiv class\x3d"swiper-pagination"\x3e\x3c/div\x3e\r\n    \x3cdiv class\x3d"swiper-scrollbar"\x3e\x3c/div\x3e\r\n\x3c/div\x3e'}});
define("require dojo/_base/declare dijit/_WidgetBase dojo/dom-construct dojo/query dojo/_base/array jimu/utils dojo/_base/lang dijit/layout/ContentPane dojo/dom-attr dojo/dom-style dojo/dom-class dojo/on dojo/Deferred dojo/Evented dojo/promise/all jimu/dijit/Message jimu/dijit/TabContainer dojo/text!./item-list.html esri/Color esri/dijit/Directions esri/dijit/PopupTemplate esri/graphic esri/geometry/Point esri/geometry/Polyline esri/geometry/Polygon esri/SpatialReference esri/geometry/geometryEngine esri/layers/FeatureLayer esri/layers/GraphicsLayer esri/symbols/jsonUtils esri/symbols/SimpleFillSymbol esri/symbols/SimpleLineSymbol esri/symbols/SimpleMarkerSymbol esri/tasks/query esri/tasks/RelationshipQuery esri/units dojo/_base/fx dojo/number jimu/LayerInfos/LayerInfos jimu/FilterManager esri/geometry/webMercatorUtils dijit/registry jimu/dijit/EditorXssFilter esri/renderers/jsonUtils jimu/symbolUtils esri/geometry/Multipoint dojo/keys dijit/focus dojo/string esri/geometry/scaleUtils ./libs/swiper dojo/text!./swiperLayout.html dojo/_base/event ./closestGeodesicDistanceUtils".split(" "),
function(T,U,V,k,m,t,A,g,I,p,h,n,x,F,W,L,X,Y,Z,K,aa,M,G,ba,N,ca,H,da,O,ea,fa,P,C,Q,ha,ia,ja,ka,J,R,la,ma,q,na,oa,pa,qa,y,z,ra,sa,ta,ua,S,va){return U([V,W],{_itemListTemplate:Z,_serviceArea:null,_operationalLayers:null,_selectedPoint:null,_panels:{},_currentPanel:null,map:null,config:null,folderUrl:null,loading:null,nls:null,parentDiv:null,outerContainer:null,_featureListContent:null,_featureInfoPanel:null,_directionInfoPanel:null,_tabContainer:null,_isNoFeature:null,_isSlide:!0,_loadAttachmentTimer:null,
_failedLayers:[],_routeCalculated:!1,_selectedLayer:null,_selectedItem:null,_selectedFeature:null,_selectedFeatureItem:null,_featureGraphicsLayer:null,_directionsWidget:null,_layerCount:null,_tables:[],_searchedFeatures:{},_attributeSearchList:null,_filterIcon:null,_proximityIcon:null,_gallerySwiper:[],_mediaRefreshTimers:null,_allContentPanes:[],_allLayersAreHidden:!1,postCreate:function(){this._allLayersAreHidden=!1;this._proximityIcon=this._filterIcon=null;this._gallerySwiper=[];this._allContentPanes=
[];this._tables=[];this._panels={};this._failedLayers=[];this._operationalLayers=null;this._searchedFeatures={};this._attributeSearchList=null;this._tablesLayer={};this.domNode=k.create("div",{"class":"esriCTItemListMainContainer"},this.outerContainer);this.updateListHeight();this.filterManager=la.getInstance();this._getUpdatedLayerFilters();this._createPanels();this._loadFeatureLayers();this._featureGraphicsLayer=new ea;this.map.addLayer(this._featureGraphicsLayer);this.editorXssFilter=na.getInstance()},
updateListHeight:function(){var a=h.get(this.searchOuterContainer,"height");a+=23;h.set(this.filterListMainDiv,"height","calc(100% - "+a+"px)");h.set(this.domNode,"height","calc(100% - "+a+"px)")},_createPanels:function(){this._panels.layerListPanel=k.create("div",{"class":"esriCTLayerList"},this.domNode);this._panels.featureListPanel=k.create("div",{"class":"esriCTFeatureList"},this.domNode);var a=k.toDom(this._itemListTemplate).childNodes[0];p.set(a,"tabindex",0);n.add(a,"esriCTPanelHeader");this._panels.featureListPanel.appendChild(a);
this._featureListContent=k.create("div",{"class":"esriCTFeatureListContent"},null);h.set(this._featureListContent,"color",this.config.fontColor);this._panels.featureListPanel.appendChild(this._featureListContent);this._attachEventOnBackButton(this._panels.featureListPanel);this._panels.infoPanel=k.create("div",{"class":"esriCTDirectionInfoPanel"},this.domNode);a=k.toDom(this._itemListTemplate).childNodes[0];p.set(a,"tabindex",0);n.add(a,"esriCTPanelHeader");this._panels.infoPanel.appendChild(a);this._attachEventOnBackButton(this._panels.infoPanel);
this._featureInfoPanel=new I({},null);this._featureInfoPanel.startup();this.config.enableDirection?(this._directionInfoPanel=new I({},null),this._directionInfoPanel.startup(),this._tabContainer=new Y({tabs:[{title:this.nls.informationTabTitle,content:this._featureInfoPanel},{title:this.nls.directionTabTitle,content:this._directionInfoPanel}]},k.create("div",{"class":"esriCTTabContainer"},this._panels.infoPanel)),this._tabContainer.startup(),p.set(this._featureInfoPanel.domNode,"tabindex",0),p.set(this._featureInfoPanel.domNode,
"role","document"),n.add(this._featureInfoPanel.domNode,"esriCTInfoPanelFocus"),a={"class":"esriCTProximityParent"},void 0===this.config.enableProximitySearch||this.config.enableProximitySearch||(a.style="display: none"),a=k.create("div",a,this._panels.infoPanel),this.own(this._tabContainer.on("tabChanged",g.hitch(this,function(b){this.emit("tab-change",b);b===this.nls.directionTabTitle?this._routeCalculated?"block"===h.get(this.proximityButton.parentElement,"display")?A.initLastFocusNode(this.domNodeObj,
this.proximityButton):this.emit("setLastNodeInFeatureInfo",A.getFocusNodesInDom(this._directionsWidget.domNode).reverse()[0]):this._initializeDirectionWidget():this._getFeatureInfoLastNode();this.parentDivId&&q.byId(this.parentDivId)&&q.byId(this.parentDivId).resize&&q.byId(this.parentDivId).resize()})))):(this._panels.infoPanel.appendChild(this._featureInfoPanel.domNode),n.add(this._featureInfoPanel.domNode,"esriCTFeatureInfo"),p.set(this._featureInfoPanel.domNode,"tabindex",0),p.set(this._featureInfoPanel.domNode,
"role","document"),(a=m(".esriCTItemListMainContainer .esriCTDirectionInfoPanel .esriCTPanelHeader"))&&n.add(a[0],"esriCTBorderBottom"),a={"class":"esriCTProximityParent",style:"bottom: 0px"},void 0===this.config.enableProximitySearch||this.config.enableProximitySearch||(a.style="display: none"),a=k.create("div",a,this._panels.infoPanel));this.proximityButton=k.create("div",{"class":"esriCTProximityIconContainer",title:this.nls.proximityButtonTooltip,"aria-label":this.nls.proximityButtonTooltip,tabindex:"0",
role:"button"},a);this._proximityIcon=k.create("div",{"class":"esriCTProximityIcon",style:{"background-color":this.selectedThemeColor}},this.proximityButton);this.own(x(this.proximityButton,"click",g.hitch(this,function(){this._selectedFeature&&this._selectedFeature.geometry&&this.emit("init-proximity",new G(this._selectedFeature.geometry))})));this.own(x(this.proximityButton,"keydown",g.hitch(this,function(b){(b.keyCode===y.ENTER||b.keyCode===y.SPACE)&&this._selectedFeature&&this._selectedFeature.geometry&&
this.emit("init-proximity",new G(this._selectedFeature.geometry))})));this.parentDivId&&q.byId(this.parentDivId)&&q.byId(this.parentDivId).resize&&q.byId(this.parentDivId).resize();this._attachEventToTab()},_attachEventOnBackButton:function(a){var b=m(".esriCTItemlList",a)[0];var c=m(".esriCTBackButton",a)[0];b&&c&&this.own(x(b,"click, keypress",g.hitch(this,function(d){if("keypress"===d.type){var e=d.charCode||d.keyCode;if(e!==y.ENTER&&e!==y.SPACE)return}d.stopPropagation();"none"!==h.get(c,"display")&&
this._isSlide&&(this._isSlide=!1,this._selectedItem=null,this._clearGrahics(),this._clearDirections(),this._clearMediaRefreshTimers(),this._isFeatureList?(this._isFeatureList=!1,this._showPanel("featureListPanel",!0),z.focus(m(".esriCTItemlList[tabindex\x3d'0']",this._featureListContent)[0])):(this.loading.hide(),this._clearContent(this._featureListContent),this.config.selectedSearchLayerOnly&&this.showLayersOnBackToLayerList(),this._selectedLayer=null,this._isFeatureList=!1,this._showPanel("layerListPanel",
!0),z.focus(m(".esriCTItemlList[tabindex\x3d'0']",this._panels.layerListPanel)[0])))})))},_loadFeatureLayers:function(){var a;this._operationalLayers=[];this._tables=this.map.webMapResponse.itemInfo.itemData.tables;for(a=0;a<this.config.searchLayers.length;a++)this.config.searchLayers[a].popupInfo||this.config.searchLayers.splice(a,1);for(a=0;a<this.config.searchLayers.length;a++)if(this.config.searchLayers[a].popupInfo){var b=new O(this.config.searchLayers[a].url,{infoTemplate:new M(this.config.searchLayers[a].popupInfo)});
b.id=this.config.searchLayers[a].id?this.config.searchLayers[a].id:"FL_"+this.config.searchLayers[a].title+a;b.title=this.config.searchLayers[a].title;this.config.searchLayers[a].definitionExpression&&b.setDefinitionExpression(this.config.searchLayers[a].definitionExpression);this.config.searchLayers[a].renderer&&b.setRenderer(oa.fromJson(this.config.searchLayers[a].renderer));b.index=a;b.layerIndex=this._operationalLayers.length;b.isMapServer=this.config.searchLayers[a].isMapServer;b.baseURL=this.config.searchLayers[a].baseURL;
b.showAttachments=this.config.searchLayers[a].popupInfo.showAttachments;this._operationalLayers.push(b);this._onLayerLoad(b)}},_onLayerLoad:function(a){a.loaded?a.tableInfos=this._getRelatedTableInfo(a.index):this.own(a.on("load",g.hitch(this,function(){a.tableInfos=this._getRelatedTableInfo(a.index)})))},_getRelatedTableInfo:function(a){var b,c=[];(b=this._operationalLayers[a])&&t.forEach(b.relationships,g.hitch(this,function(d){t.forEach(this._tables,g.hitch(this,function(e,f){e.url.replace(/.*?:\/\//g,
"")===(b.baseURL+d.relatedTableId).replace(/.*?:\/\//g,"")&&e.popupInfo&&(e.relationshipIds||(e.relationshipIds={}),e.relationshipIds[b.id]=d.id,c.push(f),this._tablesLayer[e.id]=new O(e.url),this._tablesLayer[e.id].showAttachments=!0)}))}));return c},hasValidLayers:function(){return this._operationalLayers&&0<this._operationalLayers.length?!0:!1},_clearContent:function(a){a&&k.empty(a)},displayLayerList:function(a,b,c){var d=[];this.loading.hide();this._layerCount=0;this._isSlide=this._isNoFeature=
!0;this._attributeSearchList=null;c?(this._attributeSearchList=c,this._tabContainer&&this._tabContainer.controlNode&&(h.set(this._tabContainer.controlNode,"display","none"),n.add(this._tabContainer.containerNode,"esriCTTopBorder"))):this._tabContainer&&this._tabContainer.controlNode&&(h.set(this._tabContainer.controlNode,"display","block"),n.remove(this._tabContainer.containerNode,"esriCTTopBorder"));this.clearResultPanel();this._getUpdatedLayerFilters();this._searchedFeatures={};this.config.showAllLayers&&
this.showAllLayers();this._setSearchedLocation(a);this._setServiceArea(b);this._failedLayers=[];this._filterConfiguredLayer(d);L(d).then(g.hitch(this,function(){var e=m(".esriCTItemlList[tabindex\x3d'0']",this._panels.layerListPanel);e&&0<e.length&&(this._currentPanelName="layerListPanel",n.add(e[e.length-1],"esriCTLastLayerFocusNode"));this._onFeatureCountComplete();this.emit("setLastNode","layerListPanel")}))},_getUpdatedLayerFilters:function(){R.getInstance(this.map,this.map.webMapResponse.itemInfo).then(g.hitch(this,
function(a){t.forEach(this.config.searchLayers,g.hitch(this,function(b){var c=a.getLayerInfoById(b.id);c&&(b.definitionExpression=c.getFilter())}))}))},_filterConfiguredLayer:function(a){this._currentPanel=this._panels.layerListPanel;h.set(this._currentPanel,"display","block");h.set(this._currentPanel,"left","0px");this._allLayersAreHidden=!0;for(var b=0;b<this._operationalLayers.length;b++)this._resetFilter(this._operationalLayers[b].layerIndex),this._createItemTemplate(this._operationalLayers[b],
a);1===this._operationalLayers.length&&this._getOperationalLayersVisibility(this._operationalLayers[0].url,this._operationalLayers[0].id)&&(h.set(this._panels.layerListPanel,"display","none"),this._onSingleLayerFound(null,this._operationalLayers[0]))},_onSingleLayerFound:function(a,b){if(a){var c=new F;a.push(c)}(a=m(".esriCTBackButton",this._panels.featureListPanel)[0])&&h.set(a,"display","none");this._currentPanel=this._panels.featureListPanel;h.set(this._currentPanel,"display","block");h.set(this._currentPanel,
"left","0px");b&&this._displayFeatureList(b,c)},_onSingleFeatureFound:function(a){this._displayFilteredFeatures(a.attributes[this._selectedLayer.objectIdField]);this._showFeatureDetails(null,a);if(a=m(".esriCTBackButton",this._panels.infoPanel)[0])h.set(a,"display","block"),1===this._layerCount&&h.set(this._panels.featureListPanel,"display","none")},_createItemTemplate:function(a,b){var c=k.toDom(this._itemListTemplate).childNodes[0];n.add(c,"esriCTDisabled");h.set(c,"color",this.config.fontColor);
this._currentPanel.appendChild(c);this._setItemName(c,a.title);this._queryForCountOnly(c,a,b);this._attachClickEvent(c,a,!0)},_setItemName:function(a,b,c){c&&(a=m(c,a)[0]);if(c=m(".esriCTItemName",a)[0])p.set(c,"innerHTML",b),p.set(a,"aria-label",A.stripHTML(b||"")),p.set(a,"title",A.stripHTML(b||""))},_attachClickEvent:function(a,b){this.own(x(a,"click, keypress",g.hitch(this,function(c){if("keypress"===c.type){var d=c.charCode||c.keyCode;if(d!==y.ENTER&&d!==y.SPACE)return}!n.contains(a,"esriCTDisabled")&&
this._isSlide&&(c.stopPropagation(),this._isSlide=!1,this._selectedItem=a,(c=m(".esriCTBackButton",this._panels.featureListPanel)[0])&&h.set(c,"display","block"),this._displayFeatureList(b,null))})))},_displayFeatureList:function(a,b){this._clearContent(this._featureListContent);this._selectedLayer=a;if(this.config.enableDirection){var c=m(".jimu-tab",this._panels.infoPanel);var d=m(".jimu-tab .control",this._panels.infoPanel);var e=m(".esriCTItemListMainContainer .esriCTDirectionInfoPanel .esriCTPanelHeader");
d&&d[0]&&c&&c[0]&&e&&e[0]&&("esriGeometryPolygon"===a.geometryType&&this.config.intersectSearchedLocation?(n.add(c[0],"esriCTOverrideHeight"),n.add(d[0],"esriCTHidden"),n.add(e[0],"esriCTBorderBottom")):(n.remove(c[0],"esriCTOverrideHeight"),n.remove(d[0],"esriCTHidden"),n.remove(e[0],"esriCTBorderBottom")))}this._setItemName(this._panels.featureListPanel,this._selectedLayer.title,".esriCTPanelHeader");this._queryForFeatureList(b)},_getQueryParams:function(a){var b=new ha;b.spatialRelationship="esriSpatialRelIntersects";
b.outSpatialReference=this.map.spatialReference;b.outFields=["*"];if(this._attributeSearchList)this._attributeSearchList[a.id]&&0<this._attributeSearchList[a.id].length?b.objectIds=this._attributeSearchList[a.id]:b.where="1\x3d2";else if(this._serviceArea||this._selectedPoint)b.geometry=this._serviceArea||this._selectedPoint.geometry;return b},_queryForCountOnly:function(a,b,c){var d;var e=this._getQueryParams(b);if(d=this._getOperationalLayersVisibility(b.url,b.id))this._allLayersAreHidden=!1;this.config.intersectSearchedLocation&&
"esriGeometryPolygon"===b.geometryType&&this._selectedPoint&&(e.geometry=this._selectedPoint.geometry);var f=new F;e.where&&"1\x3d2"===e.where||!d?(h.set(a,"display","none"),p.set(a,"tabindex","-1"),z.focus(m(".esriCTItemlList[tabindex\x3d'0']",a.parentElement)[0]),this.config.selectedSearchLayerOnly&&this._showHideOperationalLayer(b.url,b.id,!1),f.resolve()):b.queryFeatures(e,g.hitch(this,function(l){0<l.features.length&&d?(this._selectedLayer=b,this._layerCount++,this._searchedFeatures[b.id]=l.features,
this._setItemCount(a,l.features.length,!0),this._showFilteredFeaturesOnLoad(l.features,b.id)):(h.set(a,"display","none"),p.set(a,"tabindex","-1"),z.focus(m(".esriCTItemlList[tabindex\x3d'0']",a.parentElement)[0]),this.config.selectedSearchLayerOnly&&this._showHideOperationalLayer(b.url,b.id,!1));f.resolve()}),g.hitch(this,function(){a&&(h.set(a,"display","none"),p.set(a,"tabindex","-1"),z.focus(m(".esriCTItemlList[tabindex\x3d'0']",a.parentElement)[0]),this.config.selectedSearchLayerOnly&&this._showHideOperationalLayer(b.url,
b.id,!1));this._failedLayers.push(b.title);f.resolve()}));c.push(f)},_getFeatureLayerDetailsFormArray:function(a){var b;if(this._operationalLayers&&0<this._operationalLayers.length){var c=this._operationalLayers.length;for(b=0;b<c;b++)if(this._operationalLayers[b].id===a)return this._operationalLayers[b]}return null},_showFilteredFeaturesOnLoad:function(a,b){var c,d="",e;b=this._getFeatureLayerDetailsFormArray(b);if(this.config.selectedSearchLayerOnly&&(1<a.length&&(a=this._getSortedFeatureList(a)),
e=this._getMaxResultCountValue(a.length,b.maxRecordCount))){for(c=0;c<e;c++)d&&(d+=","),d+=a[c].attributes[this._selectedLayer.objectIdField];a=this._selectedLayer.objectIdField+" in ("+d+")";this._setFilterOnMapLayer(a,b.id,b.url,b.isMapServer)}},_onFeatureCountComplete:function(){if(this._isNoFeature){this.clearResultPanel();h.set(this._panels.layerListPanel,"display","block");h.set(this._panels.layerListPanel,"left","0px");var a=this.editorXssFilter.sanitize(this.config.noFeatureFoundMessage);
a=a?a:this.editorXssFilter.sanitize(this.nls.noFeatureFoundText);if(this._attributeSearchList||this._allLayersAreHidden)a=this.editorXssFilter.sanitize(this.nls.errorInAttributeSearch);k.create("div",{"class":"esriCTNoFeatureFound","aria-label":a,innerHTML:a},this._panels.layerListPanel);this.emit("noFeatureFound")}else 1===this._layerCount&&1!==this._operationalLayers.length&&(h.set(this._panels.layerListPanel,"display","none"),this._onSingleLayerFound(null,this._selectedLayer));this._failedLayers.length&&
(a=this.nls.unableToFetchResults+"\n\x3c/t\x3e\x3cul\x3e\x3cli\x3e"+this._failedLayers.join("\n \x3c/li\x3e\x3cli\x3e")+"\x3c/li\x3e\x3c/ul\x3e",this._showMessage(a));this.loading.hide();this.parentDivId&&q.byId(this.parentDivId)&&q.byId(this.parentDivId).resize&&q.byId(this.parentDivId).resize()},_queryForFeatureList:function(a){this.loading.show();if(this._searchedFeatures[this._selectedLayer.id])this.config.selectedSearchLayerOnly&&this._hideAllLayers(),0<this._searchedFeatures[this._selectedLayer.id].length&&
this._creatFeatureList(this._searchedFeatures[this._selectedLayer.id]),this.loading.hide(),a&&a.resolve();else{var b=this._getQueryParams(this._selectedLayer);this.config.intersectSearchedLocation&&this._selectedLayer&&"esriGeometryPolygon"===this._selectedLayer.geometryType&&this._selectedPoint&&(b.geometry=this._selectedPoint.geometry);this._selectedLayer.queryFeatures(b,g.hitch(this,function(c){this.config.selectedSearchLayerOnly?(this._hideAllLayers(),0<c.features.length&&(this._showFilteredFeaturesOnLoad(c.features,
this._selectedLayer.id),this._creatFeatureList(c.features))):0<c.features.length&&this._getOperationalLayersVisibility(this._selectedLayer.url,this._selectedLayer.id)&&(this._showFilteredFeaturesOnLoad(c.features,this._selectedLayer.id),this._creatFeatureList(c.features));this.loading.hide();a&&a.resolve()}),g.hitch(this,function(){this.loading.hide();this._failedLayers.push(this._selectedLayer.title);a&&a.resolve()}))}},resetAllFilters:function(){for(var a=0;a<this._operationalLayers.length;a++)this._resetFilter(this._operationalLayers[a].layerIndex)},
_setItemCount:function(a,b,c){var d=m(".esriCTItemCount",a)[0];m(".esriCTItemName",a);d&&(n.remove(d,"esriCTLoadingIcon"),c?(b=this._getMaxResultCountValue(b,this._selectedLayer.maxRecordCount),this.config.showFeaturesCount&&(p.set(d,"innerHTML","("+J.format(b)+")"),d=p.get(a,"title")+" "+J.format(b),p.set(a,"title",d),p.set(a,"aria-label",d)),b&&(this._isNoFeature=!1,n.remove(a,"esriCTDisabled"),p.set(a,"tabindex","0"),p.set(a,"role","button"),z.focus(m(".esriCTItemlList[tabindex\x3d'0']",a.parentElement)[0]))):
(b=J.format(b.toFixed(2))+" "+this.nls.units[this.config.bufferDistanceUnit.value].acronym,p.set(d,"innerHTML",b),a&&(d=p.get(a,"title")+" "+b,p.set(a,"title",d),p.set(a,"aria-label",d))))},_getMaxResultCountValue:function(a,b){b||(b=1E3);return!this._attributeSearchList&&this.config.maxResultCount&&this.config.maxResultCount<=b?a<this.config.maxResultCount?a:this.config.maxResultCount:a<b?a:b},_creatFeatureList:function(a){var b="",c;var d=m(".esriCTPanelHeader",this._panels.featureListPanel)[0];
this._isNoFeature=!1;0<a.length&&(a=this._getSortedFeatureList(a),d&&this._setItemCount(d,a.length,!0));var e=this._getMaxResultCountValue(a.length,this._selectedLayer.maxRecordCount);if(1===e)this._onSingleFeatureFound(a[0]);else{for(d=0;d<e;d++){b&&(b+=",");b+=a[d].attributes[this._selectedLayer.objectIdField];var f=k.toDom(this._itemListTemplate).childNodes[0];n.add(f,"esriCTFeatureListItem");d===e-1&&n.add(f,"esriCTLastFeatureFocusNode");p.set(f,"tabindex","0");p.set(f,"role","button");p.set(f,
"aria-label",a[d].getTitle());this._featureListContent.appendChild(f);this._setItemName(f,a[d].getTitle()||"");this._attributeSearchList||!a[d].geometry||a[d].geometry&&"polygon"===a[d].geometry.type&&this.config.intersectSearchedLocation?(c=m(".esriCTItemCount",f)[0])&&n.remove(c,"esriCTLoadingIcon"):a[d].hasOwnProperty("distanceToLocation")&&this._setItemCount(f,a[d].distanceToLocation,!1);this._attachEventOnFeatureDiv(f,a[d])}this.parentDivId&&q.byId(this.parentDivId)&&q.byId(this.parentDivId).resize&&
q.byId(this.parentDivId).resize();this._displayFilteredFeatures(b);this._showPanel("featureListPanel");z.focus(m(".esriCTItemlList[tabindex\x3d'0']",this._featureListContent)[0]);this.loading.hide();1===e&&f.click()}},_displayFilteredFeatures:function(a){this.config.selectedSearchLayerOnly&&(this._showHideOperationalLayer(this._selectedLayer.url,this._selectedLayer.id,!0),this._selectedLayer.setDefinitionExpression(this._selectedLayer.objectIdField+" in ("+a+")"))},_setFilterOnMapLayer:function(a,
b,c,d){b&&(d?(b=b.substring(0,b.lastIndexOf("_")),(c=this.map.getLayer(b))&&this.filterManager.applyWidgetFilter(b,this.id,a)):(c=this.map.getLayer(b))&&this.filterManager.applyWidgetFilter(b,this.id,a))},_resetFilter:function(a){var b=this._operationalLayers[a].isMapServer?this._operationalLayers[a].id.substring(0,this._operationalLayers[a].id.lastIndexOf("_")):this._operationalLayers[a].id;this.filterManager.getWidgetFilter(b,this.id)?(this._setFilterOnMapLayer("",this._operationalLayers[a].id,
this._operationalLayers[a].url,this._operationalLayers[a].isMapServer),R.getInstance(this.map,this.map.webMapResponse.itemInfo).then(g.hitch(this,function(c){var d;if(d=c.getLayerInfoById(b)){var e=d.getFilter();!e&&this._operationalLayers[a].isMapServer&&(d=c.getLayerInfoById(this._operationalLayers[a].id))&&(e=d.getFilter());this.config.searchLayers[a].definitionExpression=e;this._operationalLayers[a].setDefinitionExpression(e)}}))):this._operationalLayers[a]&&this.config.searchLayers[a]&&this._operationalLayers[a].setDefinitionExpression(this.config.searchLayers[a].definitionExpression)},
_getSortedFeatureList:function(a){var b;var c=this._canGetGeodesicDistance();for(b=0;b<a.length;b++)a[b].distanceToLocation=this._attributeSearchList?a[b].getTitle().toLowerCase():c&&a[b].geometry?this._getGeodesicDistances(a[b].geometry):this._selectedPoint&&a[b].geometry?da.distance(this._selectedPoint.geometry,a[b].geometry,this.config.bufferDistanceUnit.distanceUnit):0;a.sort(function(d,e){return d.distanceToLocation<e.distanceToLocation?-1:d.distanceToLocation>e.distanceToLocation?1:0});return a},
_canGetGeodesicDistance:function(){var a=new H(4326);return this.config.isGeodesic&&this._selectedPoint&&ma.canProject(this._selectedPoint.geometry,a)?!0:!1},_getGeodesicDistances:function(a){return this._selectedPoint&&this._selectedPoint.geometry&&a?va.getGeodesicDistance(this._selectedPoint.geometry,a,this.config.bufferDistanceUnit.distanceUnit):0},_attachEventOnFeatureDiv:function(a,b){this.own(x(a,"click, keypress",g.hitch(this,function(c){if("keypress"===c.type&&(c=c.charCode||c.keyCode,c!==
y.ENTER&&c!==y.SPACE))return;this._isFeatureList=!0;(c=m(".esriCTBackButton",this._panels.infoPanel)[0])&&h.set(c,"display","block");this._showFeatureDetails(a,b)})))},_showFeatureDetails:function(a,b){this._setItemName(this._panels.infoPanel,this._selectedLayer.title,".esriCTPanelHeader");this._showPanel("infoPanel");var c=m(".esriCTProximityParent",this.domNode);c&&0<c.length&&(c=c[0],b.geometry?n.remove(c,"esriCTHidden"):n.add(c,"esriCTHidden"));this._tabContainer&&(this._tabContainer.selectTab(this.nls.informationTabTitle),
!b.geometry||this._attributeSearchList?(h.set(this._tabContainer.controlNode,"display","none"),n.add(this._tabContainer.containerNode,"esriCTTopBorder")):(h.set(this._tabContainer.controlNode,"display","block"),n.remove(this._tabContainer.containerNode,"esriCTTopBorder")));this._selectedFeatureItem=a;this._selectedFeature=b;this._clearDirections();this._highlightFeatureOnMap();this._displayFeatureInfo(b);this.parentDivId&&q.byId(this.parentDivId)&&q.byId(this.parentDivId).resize&&q.byId(this.parentDivId).resize()},
_zoomToSelectedPointFeature:function(a){var b;this.config.searchSourceSettings&&this.config.searchSourceSettings.sources&&0<this.config.searchSourceSettings.sources.length&&t.some(this.config.searchSourceSettings.sources,g.hitch(this,function(c){if(c&&c.layerId&&this._selectedLayer.id&&c.layerId===this._selectedLayer.id)return b=sa.getExtentForScale(this.map,c.zoomScale).centerAt(a.geometry),!0}));b?this.map.setExtent(b):this.map.centerAndZoom(a.geometry,this.map.getMaxZoom()-1)},_displayFeatureInfo:function(a){var b;
this._loadAttachmentTimer&&clearTimeout(this._loadAttachmentTimer);this._featureInfoPanel&&(this._featureInfoPanel.set("content",""),this._gallerySwiper=[],this._allContentPanes=[],this._attributeSearchList||!a.geometry||a.geometry&&"polygon"===a.geometry.type&&this.config.intersectSearchedLocation||this._addDistanceToLocationInDetailsPanel(a),this._showPopupInfo(a,a._layer),this.config.attributeSymbology&&(b=this._getConfiguredSymbologyForLayer(this._selectedLayer.id))&&0<b.length&&this._checkAttributeSymbology(a,
b));if(this.config.zoomToFeature)if(a.geometry&&"point"===a.geometry.type)if(b=a.geometry,this._selectedPoint){var c=this._getPointFromGeometry(this._selectedPoint.geometry);b={paths:[[[b.x,b.y],[c.x,c.y]]],spatialReference:this.map.spatialReference};b=new N(b);this.map.setExtent(b.getExtent().expand(1.5))}else this._zoomToSelectedPointFeature(a);else a.geometry&&this.map.setExtent(a.geometry.getExtent().expand(1.5));this._getRelatedRecords(a)},_addDistanceToLocationInDetailsPanel:function(a){if(a.hasOwnProperty("distanceToLocation")){a=
J.format(a.distanceToLocation.toFixed(2))+" "+this.nls.units[this.config.bufferDistanceUnit.value].acronym;a=k.create("div",{innerHTML:ra.substitute(this.nls.approximateDistanceTitle,{DistanceToLocation:a}),"class":"esriCTDistanceToLocation"});var b=new I({style:{padding:"0px"}});b.set("content",a);this._featureInfoPanel.addChild(b)}},_getRelatedRecords:function(a){t.forEach(this._selectedLayer.tableInfos,g.hitch(this,function(b){this._queryRelatedRecords(this._tables[b],a.attributes[this._selectedLayer.objectIdField])}))},
_queryRelatedRecords:function(a,b){if(this._selectedLayer&&a){var c=new ia;c.objectIds=[parseInt(b,10)];c.outFields=["*"];c.relationshipId=a.relationshipIds[this._selectedLayer.id];a.layerDefinition&&a.layerDefinition.definitionExpression&&(c.definitionExpression=a.layerDefinition.definitionExpression);this._selectedLayer.queryRelatedFeatures(c,g.hitch(this,function(d){d=d[b];t.forEach(d?d.features:[],g.hitch(this,function(e){e.setInfoTemplate(new M(a.popupInfo));this._showPopupInfo(e,this._tablesLayer[a.id])}));
this.parentDivId&&q.byId(this.parentDivId)&&q.byId(this.parentDivId).resize&&q.byId(this.parentDivId).resize()}))}},_showPopupInfo:function(a,b){if(this._featureInfoPanel&&a){a._layer||(a._layer=b);a._layer._map||(a._layer._map=this.map);var c=new I({"class":"esriCTPopupInfo"});var d=a.getContent();var e=q.byId(d.id);c.set("content",d);this.own(x(e,"content-update",g.hitch(this,function(){this._getFeatureInfoLastNode();z.focus(this._featureInfoPanel.domNode)})));this._allContentPanes.push(c);this._featureInfoPanel.addChild(c);
this._checkAttachments(e,a,b)}},_checkAttachments:function(a,b,c){n.add(m(".mediaSection",a.domNode)[0],"esriCTHidden");var d=m(".attachmentsSection",a.domNode)[0];k.empty(d);n.remove(d,"hidden");c.hasAttachments&&c.showAttachments?(this.loading.show(),this._loadAttachmentTimer=setTimeout(g.hitch(this,function(){this._showAttachments(b,d,c,a)}),500)):this._createGallery(c,d,[],a)},_showAttachments:function(a,b,c,d){this.config.showImageGallery?(a=a.attributes[c.objectIdField],k.empty(b),c.queryAttachmentInfos(a,
g.hitch(this,function(e){this.loading.hide();this._createGallery(c,b,e,d);this.parentDivId&&q.byId(this.parentDivId)&&q.byId(this.parentDivId).resize&&q.byId(this.parentDivId).resize()}))):(this.loading.hide(),n.add(b,"esriCTHidden"),this._getFeatureInfoLastNode())},resetGallery:function(){"infoPanel"===this._currentPanelName&&(!this._tabContainer||this._tabContainer&&this._tabContainer.selected===this.nls.informationTabTitle)&&this._gallerySwiper&&(t.forEach(this._gallerySwiper,function(a){a&&(a.update(),
a.slideReset())},this),this._getFeatureInfoLastNode())},_createGallery:function(a,b,c,d){var e;this._clearMediaRefreshTimers();this.config.showImageGallery&&(c=this._checkForHyperlinks(c,this._selectedFeature));var f=c.length,l=[];if(c&&0<c.length||a&&a.infoTemplate&&a.infoTemplate.info&&a.infoTemplate.info.mediaInfos&&0<a.infoTemplate.info.mediaInfos.length){a.infoTemplate&&a.infoTemplate.info&&a.infoTemplate.info.mediaInfos&&(f+=a.infoTemplate.info.mediaInfos.length);this.loading.show();a=k.create("div",
{"class":"esriCTThumbnailContainer"},b);k.create("div",{style:{clear:"both"}},a);var r=k.toDom(ua);var u=m(".swiper-wrapper",r)[0];var v=!1;if(c&&0<c.length)for(a=0;a<c.length;a++)if(0>l.indexOf(c[a].url))if(l.push(c[a].url),-1!==c[a].contentType.indexOf("image")&&c[a].contentType.match(/(\/tiff)/)&&(c[a].contentType="application/tiff"),c[a].contentType&&-1<c[a].contentType.indexOf("image")){var w=k.create("div",{"class":"swiper-slide"},u);var B=k.create("img",{alt:c[a].name,"class":"esriCTAttachmentImg",
src:c[a].url},w);this._attachEventOnImage(B,null);v=!0}else c[a].contentType&&-1<c[a].contentType.toLowerCase().indexOf("video/mp4")?(w=k.create("div",{"class":"swiper-slide"},u),B=k.toDom('\x3cvideo class\x3d"esriCTVideoElement" src\x3d"'+c[a].url+'" height\x3d"auto" width\x3d"100%" controls\x3e\x3csource src\x3d"'+c[a].url+'" type\x3d"'+c[a].contentType+'" poster\x3d"'+c[a].url+'"\x3e\x3c/video\x3e'),k.place(B,w),v=!0):(w=k.create("div",{"class":"esriCTNonImageAttachmentContainer",tabindex:"0",
"aria-label":c[a].name,role:"button",src:c[a].url},b),B=this.folderUrl+"images/no-attachment.png",B=k.create("img",{alt:"","class":"esriCTNonImageAttachmentImg esriCTAutoHeight",src:B},w),B=k.create("div",{"class":"esriCTImageFormatDiv"},w),this._fetchDocumentContentType(c[a],B),this._attachEventOnImage(w,null));this._charts=[];this._checkMediaInfos(u,d,l).then(g.hitch(this,function(wa){if(v||wa)k.place(r,b),e=new ta(r,{height:"250px",pagination:".swiper-pagination",nextButton:".swiper-button-next",
prevButton:".swiper-button-prev",slidesPerView:1,paginationClickable:!0,spaceBetween:30,loop:!0,a11y:!0}),this.own(x(e,"onSlideChangeStart",g.hitch(this,function(){t.forEach(m(".esriCTVideoElement",u),g.hitch(this,function(D){D.pause()}))}))),this.own(x(e,"imagesReady",g.hitch(this,function(){t.forEach(m(".swiper-slide-duplicate",u),g.hitch(this,function(D){var E;(E=m(".esriCTAttachmentImg",D))&&0<E.length&&(E=E[0],D=p.get(E,"refreshInterval"),this._attachEventOnImage(E,D))}))}))),t.forEach(this._charts,
g.hitch(this,function(D){D.resize(200,200)})),1===f&&(e.nextButton&&0<e.nextButton.length&&n.add(e.nextButton[0],"esriCTHidden"),e.prevButton&&0<e.prevButton.length&&n.add(e.prevButton[0],"esriCTHidden"),e.lockSwipes());this.loading.hide();this._gallerySwiper.push(e);this._getFeatureInfoLastNode();d._clearImageHandles&&d._clearImageHandles()}))}else this._gallerySwiper.push(null),this._getFeatureInfoLastNode(),d._clearImageHandles&&d._clearImageHandles()},_getFeatureInfoLastNode:function(){var a;
if("block"===h.get(this.proximityButton.parentElement,"display"))var b=this.proximityButton;if(!b)for(var c=this._allContentPanes.length-1;0<=c&&((a=m(".swiper-pagination-bullet",this._allContentPanes[c].domNode))&&0<a.length?b=a.reverse()[0]:(a=A.getFocusNodesInDom(this._allContentPanes[c].domNode))&&0<a.length&&(b=a.reverse()[0]),!b);c--);!b&&this._featureInfoPanel&&this._featureInfoPanel.domNode&&(b=this._featureInfoPanel.domNode);if(!b&&(b=this._getInformationTabAsLastFocusNode()))return;b||(b=
m(".esriCTItemListMainContainer .esriCTDirectionInfoPanel .esriCTPanelHeader",this.domNode.parentElement)[0]);this.emit("setLastNodeInFeatureInfo",b)},_checkForHyperlinks:function(a,b){var c;var d=[];d=b.attributes;for(c in d)d.hasOwnProperty(c)&&d[c]&&String(d[c]).match(/^(http(s?):)/)&&(String(d[c]).match(/\.(png|jpg|jpeg|gif|bmp)(\/|$)/i)?(b={},b.contentType="image/"+String(d[c]).match(/\.(png|jpg|jpeg|gif|bmp)(\/|$)/i)[1],b.url=d[c],a.push(b)):String(d[c]).match(/\.(mp4)(\/?)/i)&&(b={contentType:"video/mp4"},
b.url=d[c],a.push(b)));return a},_checkMediaInfos:function(a,b,c){var d,e;var f=new F;var l=[];if(b._mediaInfos&&0<b._mediaInfos.length)var r=b._mediaInfos;else b&&b.template.info&&b.template.info.mediaInfos&&0<b.template.info.mediaInfos.length&&(r=b.template.info.mediaInfos);r&&b._mediaInfos&&0<b._mediaInfos.length?setTimeout(g.hitch(this,function(){for(var u=0;u<r.length;u++){var v=r[u],w=0;("image"===v.type||"image"!==v.type&&v.value.fields&&0<v.value.fields.length)&&0>c.indexOf(v.value.sourceURL)&&
(c.push(v.value.sourceURL),d=k.create("div",{"class":"swiper-slide"},a),"image"===v.type?(v.hasOwnProperty("refreshInterval")&&(w=v.refreshInterval),e=k.create("img",{alt:v.value.sourceURL,"class":"esriCTAttachmentImg",src:v.value.sourceURL,refreshInterval:w},d),w&&p.set("refreshInterval",w),this._attachEventOnImage(e,w)):l.push(this._loadMediaCharts(b,v,d)))}0<l.length?L(l).then(g.hitch(this,function(){f.resolve(!0)})):f.resolve(!0)}),1E3):f.resolve(!1);return f.promise},_loadMediaCharts:function(a,
b,c){var d=new F,e=this,f=["dojox/charting/Chart2D","dojox/charting/action2d/Tooltip"];a=b.value.theme||a.chartTheme;g.isString(a)&&(a=a.replace(/\./gi,"/"),-1===a.indexOf("/")&&(a="dojox/charting/themes/"+a));a||(a="esri/dijit/Rainbow");f.push(a);try{T(f,function(l,r,u){e._createChart(c,b,l,r,u).then(g.hitch(this,function(){d.resolve()}))})}catch(l){d.resolve()}return d.promise},_createChart:function(a,b,c,d,e){var f=b.type;var l=b.value;b=new F;c=new c(k.create("div",{"class":"chart"},a));e&&c.setTheme(e);
switch(f){case "piechart":c.addPlot("default",{type:"Pie",labels:!1});c.addSeries("Series A",l.fields);break;case "linechart":c.addPlot("default",{type:"Markers"});c.addAxis("x",{min:0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1});c.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"});t.forEach(l.fields,function(r,u){r.x=u+1});c.addSeries("Series A",l.fields);break;case "columnchart":c.addPlot("default",{type:"Columns",gap:3});c.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"});
c.addSeries("Series A",l.fields);break;case "barchart":c.addPlot("default",{type:"Bars",gap:3}),c.addAxis("x",{includeZero:!0,fixUpper:"minor",minorLabels:!1}),c.addAxis("y",{vertical:!0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),c.addSeries("Series A",l.fields)}new d(c);c.render();this._charts.push(c);b.resolve();return b.promise},_fetchDocumentContentType:function(a,b){a=(a=/(?:\.([^.]+))?$/.exec(a.name))&&a[1]?"."+a[1].toUpperCase():this.nls.unknownAttachmentExt;p.set(b,"innerHTML",
a)},updateImageData:function(a){fetch(a.alt,{cache:"no-cache"}).then(function(b){URL.revokeObjectURL(a.src);b.blob().then(function(c){a.setAttribute("src",URL.createObjectURL(c))})})},_attachEventOnImage:function(a,b){this.own(x(a,"click",g.hitch(this,function(){this._displayImageAttachments(a,!1)})));this.own(x(a,"keydown",g.hitch(this,function(c){this._displayImageAttachments(a,!0,c)})));b&&(b*=6E4)&&0<b&&(b=setInterval(g.hitch(this,function(){this.updateImageData(a)}),b),this._mediaRefreshTimers.push(b))},
_clearMediaRefreshTimers:function(){this._mediaRefreshTimers&&t.forEach(this._mediaRefreshTimers,function(a){clearInterval(a)});this._mediaRefreshTimers=[]},_displayImageAttachments:function(a,b,c){b&&c.keyCode!==y.ENTER&&c.keyCode!==y.SPACE||window.open(p.get(a,"src"))},_onImageLoad:function(a){n.remove(a.target.parentNode,"esriCTImageLoader");this._setImageDimensions(a.target)},_setImageDimensions:function(a){var b=a.parentElement;if(a&&0<a.offsetHeight){p.set(a,"originalHeight",a.offsetHeight);
h.set(a,"maxHeight",a.offsetHeight+"px");h.set(a,"maxWidth",a.offsetWidth+"px");var c=parseFloat(p.get(a,"originalHeight"));if(b.offsetHeight<a.offsetHeight||c>b.offsetHeight)c=a.offsetWidth/a.offsetHeight,b=b.offsetHeight-2,c=Math.floor(b*c),n.remove(a,"esriCTAutoHeight"),h.set(a,"width",c+"px"),h.set(a,"height",b+"px")}},_onError:function(a){n.remove(a.target.parentNode,"esriCTImageLoader")},_setSearchedLocation:function(a){this._selectedPoint=a},_setServiceArea:function(a){this._serviceArea=a},
clearResultPanel:function(){this._isFeatureList=!1;this._clearContent(this._panels.layerListPanel);h.set(this._panels.layerListPanel,"display","none");h.set(this._panels.featureListPanel,"display","none");h.set(this._panels.infoPanel,"display","none");this._clearContent(this._featureListContent);this._clearDirections();this._clearGrahics()},removeGraphicsLayer:function(){this._featureGraphicsLayer&&(this.map.removeLayer(this._featureGraphicsLayer),this._featureGraphicsLayer=null)},_clearGrahics:function(){this._featureGraphicsLayer&&
this._featureGraphicsLayer.clear()},_showPanel:function(a,b){h.set(this._panels[a],{display:"block",left:"-100%"});b?(this._slide(this._panels[a],-100,0),this._slide(this._currentPanel,0,100)):(this._slide(this._currentPanel,0,-100),this._slide(this._panels[a],100,0));this._currentPanelName=a;this._currentPanel=this._panels[a];this.parentDivId&&q.byId(this.parentDivId)&&q.byId(this.parentDivId).resize&&q.byId(this.parentDivId).resize();setTimeout(g.hitch(this,function(){this.emit("setLastNode",a)}),
400)},_slide:function(a,b,c){h.set(a,"display","block");h.set(a,"left",b+"%");ka.animateProperty({node:a,properties:{left:{start:b,end:c,units:"%"}},duration:300,onEnd:g.hitch(this,function(){h.set(a,"left",c);0===c?h.set(a,"display","block"):h.set(a,"display","none");this._isSlide=!0})}).play()},_showMessage:function(a){(new X({message:a})).message=a},_initializeDirectionWidget:function(){if(!this._directionsWidget){q.byId("directionDijit"+this.id)&&q.byId("directionDijit"+this.id).destroy();var a=
{id:"directionDijit"+this.id,map:this.map,directionsLengthUnits:ja[this.config.directionLengthUnit.routeUnit],showTrafficOption:!1,dragging:!1,routeTaskUrl:this.config.routeService,routeSymbol:new C(this.config.symbols.routeSymbol)};this.config.helperServices&&this.config.helperServices.printTask&&this.config.helperServices.printTask.url&&(a.printTaskUrl=this.config.helperServices.printTask.url);this._directionsWidget=new aa(a,k.create("div",{},null));this._directionsWidget.startup();this.own(this._directionsWidget.on("directions-finish",
g.hitch(this,function(){this._directionsWidget.zoomToFullRoute();this.parentDivId&&q.byId(this.parentDivId)&&q.byId(this.parentDivId).resize&&q.byId(this.parentDivId).resize();this.loading.hide();"block"===h.get(this.proximityButton.parentElement,"display")?A.initLastFocusNode(this.domNodeObj,this.proximityButton):this.emit("setLastNodeInFeatureInfo",A.getFocusNodesInDom(this._directionsWidget.domNode).reverse()[0])})));this._directionInfoPanel.set("content",this._directionsWidget.domNode)}this._routeSelectedLocations()},
_clearDirections:function(){this._directionsWidget&&this._routeCalculated&&this._directionsWidget.clearDirections();this._routeCalculated=!1},_getPointFromGeometry:function(a){switch(a.type){case "extent":var b=a.getCenter();break;case "multipoint":b=a.getPoint(0);break;case "point":b=a;break;case "polygon":b=a.getCentroid();break;case "polyline":b=a.getPoint(0,0)}return b},_routeSelectedLocations:function(){var a=[];this._clearDirections();this._selectedPoint&&this._selectedFeature&&this._selectedFeature.geometry&&
(this.loading.show(),a.push(this._getPointFromGeometry(this._selectedPoint.geometry)),a.push(this._getPointFromGeometry(this._selectedFeature.geometry)),this._directionsWidget.updateStops(a).then(g.hitch(this,function(){this._directionsWidget.getDirections();this._routeCalculated=!0}),g.hitch(this,function(){this.loading.hide();this._showMessage(this.nls.failedToGenerateRouteMsg)})))},_highlightFeatureOnMap:function(){var a;this._clearGrahics();this._selectedFeature&&this._selectedFeature.geometry&&
(a=this._getHighLightSymbol(this._selectedFeature,this._selectedLayer))&&a.geometry&&this._featureGraphicsLayer.add(a)},_getHighLightSymbol:function(a,b){switch(a.geometry.type){case "point":case "multipoint":return this._getPointSymbol(a,b);case "polyline":return this._getPolyLineSymbol(a,b);case "polygon":return this._getPolygonSymbol(a)}},_getHighLightSymbolColor:function(){var a=new K([0,255,255,1]);this.config.highlightColor&&(a=new K(this.config.highlightColor),this.config.hasOwnProperty("showSelectionColor")||
(this.config.showSelectionColor=!0),a.a=this.config.showSelectionColor?1:0);return a},_getPointSymbol:function(a,b){var c,d;var e=!1;var f=this._getHighLightSymbolColor();f=new Q(Q.STYLE_SQUARE,null,new C(C.STYLE_SOLID,f,3));f.setColor(null);f.size=30;if(b&&b.renderer)if(b.renderer.symbol)e=!0,f=this._updatePointSymbolProperties(f,b.renderer.symbol);else if(b.renderer.infos&&0<b.renderer.infos.length){for(d=0;d<b.renderer.infos.length;d++){b.typeIdField?c=a.attributes[b.typeIdField]:b.renderer.attributeField&&
(c=a.attributes[b.renderer.attributeField]);var l=b.renderer.infos[d].value;void 0!==c&&null!==c&&""!==c&&void 0!==l&&null!==l&&""!==l&&c.toString()===l.toString()&&(e=!0,f=this._updatePointSymbolProperties(f,b.renderer.infos[d].symbol))}!e&&b.renderer.defaultSymbol&&(e=!0,f=this._updatePointSymbolProperties(f,b.renderer.defaultSymbol))}if(a.geometry&&"point"===a.geometry.type)var r=new ba(a.geometry.x,a.geometry.y,new H({wkid:a.geometry.spatialReference.wkid}));else a.geometry&&"multipoint"===a.geometry.type&&
(r=new qa(new H({wkid:a.geometry.spatialReference.wkid})),a.geometry.points&&t.forEach(a.geometry.points,function(u){r.addPoint(u)}));return new G(r,f,a.attributes)},_updatePointSymbolProperties:function(a,b){if(b.hasOwnProperty("height")&&b.hasOwnProperty("width")){var c=b.height;var d=b.width;c=(c>d?c:d)+10;a.size=c}b.hasOwnProperty("size")&&(!c||c<b.size)&&(a.size=b.size+10);b.hasOwnProperty("xoffset")&&(a.xoffset=b.xoffset);b.hasOwnProperty("yoffset")&&(a.yoffset=b.yoffset);return a},_getPolyLineSymbol:function(a,
b){var c,d;var e=5;var f=this._getHighLightSymbolColor();if(b&&b.renderer)if(b.renderer.symbol&&b.renderer.symbol.hasOwnProperty("width"))e=b.renderer.symbol.width;else if(b.renderer.infos&&0<b.renderer.infos.length)for(d=0;d<b.renderer.infos.length;d++){b.typeIdField?c=a.attributes[b.typeIdField]:b.renderer.attributeField&&(c=a.attributes[b.renderer.attributeField]);var l=b.renderer.infos[d].value;void 0!==c&&null!==c&&""!==c&&void 0!==l&&null!==l&&""!==l&&c.toString()===l.toString()&&b.renderer.infos[d].symbol.hasOwnProperty("width")&&
(e=b.renderer.infos[d].symbol.width)}else b.renderer.defaultSymbol&&b.renderer.defaultSymbol.hasOwnProperty("width")&&(e=b.renderer.defaultSymbol.width);b=new C(C.STYLE_SOLID,f,e);var r=new N(new H({wkid:a.geometry.spatialReference.wkid}));a.geometry.paths&&0<a.geometry.paths.length&&t.forEach(a.geometry.paths,g.hitch(this,function(u){r.addPath(u)}));return new G(r,b,a.attributes)},_getPolygonSymbol:function(a){var b=this._getHighLightSymbolColor();b=new P(P.STYLE_SOLID,new C(C.STYLE_SOLID,b,4),new K([0,
0,0,0]));var c=new ca(new H({wkid:a.geometry.spatialReference.wkid}));a.geometry.rings&&(c.rings=g.clone(a.geometry.rings));return new G(c,b,a.attributes)},_hideAllLayers:function(){if(this.config.selectedSearchLayerOnly){var a;for(a=0;a<this.config.searchLayers.length;a++)this._showHideOperationalLayer(this.config.searchLayers[a].url,this.config.searchLayers[a].id,!1)}},showAllLayers:function(a){var b;for(b=0;b<this.config.searchLayers.length;b++){var c=a?this.config.searchLayers[b].visibility:!0;
this.config.selectedSearchLayerOnly&&this._searchedFeatures[this.config.searchLayers[b].id]&&1>this._searchedFeatures[this.config.searchLayers[b].id].length&&(c=!1);this._showHideOperationalLayer(this.config.searchLayers[b].url,this.config.searchLayers[b].id,c)}},showLayersOnBackToLayerList:function(){var a;for(a=0;a<this.config.searchLayers.length;a++)if(this.config.selectedSearchLayerOnly){var b=this._searchedFeatures[this.config.searchLayers[a].id]&&0<this._searchedFeatures[this.config.searchLayers[a].id].length?
!0:!1;this._showHideOperationalLayer(this.config.searchLayers[a].url,this.config.searchLayers[a].id,b)}},_showHideOperationalLayer:function(a,b,c){var d;var e=a.split("/");e=e[e.length-1];for(d in this.map._layers)if(this.map._layers.hasOwnProperty(d))if(b&&this.map._layers[d].url===a&&this.map._layers[d].id===b)this.map._layers[d].setVisibility(c);else if(this.map._layers[d].visibleLayers&&b&&this.map._layers[d].id===b.substring(0,b.lastIndexOf("_"))){var f=this.map._layers[d].url[this.map._layers[d].url.length-
1];f="/"===f?this.map._layers[d].url+e:this.map._layers[d].url+"/"+e;if(f===a){f=this.map._layers[d].visibleLayers;var l=t.indexOf(f,parseInt(e,10));c?-1===l&&f.push(parseInt(e,10)):-1!==l&&f.splice(l,1);this.map._layers[d].setVisibleLayers?this.map._layers[d].setVisibleLayers(f):(this.map._layers[d].visibleLayers=f,this.map._layers[d].setVisibility(c))}}},_getOperationalLayersVisibility:function(a,b){var c;var d=a.split("/");d=d[d.length-1];for(c in this.map._layers)if(this.map._layers.hasOwnProperty(c)){if(b&&
this.map._layers[c].url===a&&this.map._layers[c].id===b)return this.map._layers[c].visible;if(this.map._layers[c].visibleLayers&&b&&this.map._layers[c].id===b.substring(0,b.lastIndexOf("_"))){var e=this.map._layers[c].url[this.map._layers[c].url.length-1];e="/"===e?this.map._layers[c].url+d:this.map._layers[c].url+"/"+d;if(e===a&&(e=this.map._layers[c].visibleLayers,e=t.indexOf(e,parseInt(d,10)),-1!==e))return this.map._layers[c].visible}}return!1},_getConfiguredSymbologyForLayer:function(a){var b=
[];if(this.config.attributeSymbology&&this.config.attributeSymbology.hasOwnProperty(a))return this.config.attributeSymbology[a];this.config.attributeSymbology&&this.config.attributeSymbology.length&&0<this.config.attributeSymbology.length&&t.forEach(this.config.attributeSymbology,g.hitch(this,function(c){c.hasOwnProperty("layerId")&&c.layerId===a&&b.push(c)}));return b},_checkAttributeSymbology:function(a,b){var c;if(c=m(".attachmentsSection",this._featureInfoPanel.domNode)[0]){var d=k.create("div",
{"class":"esriCTAttributeSymbolWrapper"},null);k.place(d,c,"before")}t.forEach(b,g.hitch(this,function(e){a.attributes.hasOwnProperty(e.fieldName)&&a.attributes[e.fieldName]===e.fieldValue&&this._createAttributeSymbol(e,d)}))},_createAttributeSymbol:function(a,b){var c=fa.fromJson(a.symbol);a=this._selectedLayer.getField(a.fieldName);b=k.create("div",{"class":"esriCTAttributeSymbolContainer",title:a&&a.alias?a.alias:""},b);c=pa.createSymbolNode(c);k.place(c,b)},resetIconColors:function(){this._filterIcon&&
h.set(this._filterIcon,"background-color",this.selectedThemeColor);this._proximityIcon&&h.set(this._proximityIcon,"background-color",this.selectedThemeColor)},_attachEventToTab:function(){""!==this._tabContainer&&null!==this._tabContainer&&void 0!==this._tabContainer&&this._tabContainer.controlNodes&&1<this._tabContainer.controlNodes.length&&this.own(x(this._tabContainer.controlNodes[1],"keydown",g.hitch(this,function(a){a.keyCode===y.TAB&&!a.shiftKey&&this._tabContainer.viewStack&&this._tabContainer.viewStack.getSelectedLabel()===
this.nls.informationTabTitle&&(this.config.enableProximitySearch?(S.stop(a),z.focus(this.proximityButton)):(S.stop(a),this.emit("setFocusOnFirstFocusableNode")))})))},_getInformationTabAsLastFocusNode:function(){if(""!==this._tabContainer&&null!==this._tabContainer&&void 0!==this._tabContainer&&this._tabContainer.viewStack&&this._tabContainer.viewStack.getSelectedLabel()===this.nls.informationTabTitle&&this._tabContainer.controlNodes&&0<this._tabContainer.controlNodes.length){var a=this._tabContainer.controlNodes[0];
if(!this.config.enableProximitySearch)return A.initLastFocusNode(this.domNodeObj,a),!0}return!1}})});